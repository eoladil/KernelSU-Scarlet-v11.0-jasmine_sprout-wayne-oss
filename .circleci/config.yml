version: 2.1

jobs:
  build:
    machine:
      image: ubuntu-2004:current
    resource_class: medium
    steps:
      - checkout
      
      - run:
          name: "Install Build Dependencies"
          command: |
            sudo apt-get update
            sudo apt-get install -y git ccache automake flex lzop bison gperf build-essential zip curl zlib1g-dev g++-multilib libxml2-utils bzip2 libbz2-dev libbz2-1.0 squashfs-tools pngcrush schedtool dpkg-dev liblz4-tool make optipng maven libssl-dev pwgen libswitch-perl policycoreutils minicom libxml-sax-base-perl libxml-simple-perl bc libc6-dev-i386 lib32ncurses5-dev x11proto-core-dev libx11-dev lib32z-dev libgl1-mesa-dev xsltproc unzip python3
      
      - run:
          name: "Download Toolchain (Proton Clang)"
          command: |
            git clone --depth=1 https://github.com/kdrag0n/proton-clang.git clang
      
      - run:
          name: "Clone Kernel Source"
          command: |
            git clone --depth=1 https://github.com/eoladil/KernelSU-Scarlet-v11.0-jasmine_sprout-wayne-oss.git kernel-source
      
      - run:
          name: "Build the Kernel"
          command: |
            cd kernel-source
            
            # Tell the system where our compiler is
            export PATH="$CIRCLE_WORKING_DIRECTORY/clang/bin:$PATH"
            export ARCH=arm64
            export SUBARCH=arm64
            export KBUILD_BUILD_USER="builder"
            export KBUILD_BUILD_HOST="circleci"

            # 1. Generate the configuration file
            make O=out CC=clang CROSS_COMPILE=aarch64-linux-gnu- CROSS_COMPILE_ARM32=arm-linux-gnueabi- jasmine_sprout_defconfig

            # 2. Compile the kernel
            make -j$(nproc --all) O=out CC=clang CROSS_COMPILE=aarch64-linux-gnu- CROSS_COMPILE_ARM32=arm-linux-gnueabi-
      
      - run:
          name: "Clone AnyKernel3"
          command: |
            git clone https://github.com/osm0sis/AnyKernel3.git AnyKernel3
            sed -i 's/block=.*/block=\/dev\/block\/bootdevice\/by-name\/boot;/' AnyKernel3/anykernel.sh
            sed -i 's/is_slot_device=.*/is_slot_device=1;/' AnyKernel3/anykernel.sh
      
      - run:
          name: "Package the Kernel Zip"
          command: |
            cp kernel-source/out/arch/arm64/boot/Image.gz-dtb AnyKernel3/ || cp kernel-source/out/arch/arm64/boot/Image AnyKernel3/
            cd AnyKernel3
            zip -r9 ../Scarlet-KernelSU-Jasmine-ArrowOS.zip *
      
      # This uploads the final zip so you can download it from the CircleCI dashboard
      - store_artifacts:
          path: Scarlet-KernelSU-Jasmine-ArrowOS.zip
          destination: Scarlet-KernelSU-Jasmine

workflows:
  build-kernel-workflow:
    jobs:
      - build
